# 1 - Конфигурация и Параметры

Приложение разделяет конфигурацию на **статическую** (зашита в сборку/переменные окружения) и **динамическую** (вводится пользователем при первом запуске через Setup Screen).

## 1.1 - Серверная конфигурация (.NET Core)

Основные параметры хранятся в `appsettings.json` или переменных окружения.

| Параметр                | Значение по умолчанию | Описание                                        |
| :---------------------- | :-------------------- | :---------------------------------------------- |
| Kestrel:Endpoints       | Http: localhost:5000  | Порт прослушивания API.                         |
| Jwt:Issuer              | SplitflowServer       | Издатель токена авторизации.                    |
| Jwt:ExpiryMinutes       | 60                    | Время жизни Access Token (1 час).               |
| Logging:Level           | Information           | Уровень логирования (Info/Warning/Error).       |
| Cors:AllowedOrigins     | http://localhost:5173 | Разрешенный адрес фронтенда (Vite).             |
| App:MaxPageSize         | 50                    | Максимальное кол-во элементов в списках.        |

## 1.2 - Динамическая конфигурация (Setup Module)

Так как приложение поддерживает "коробочную" установку, строка подключения к БД не хранится в коде.

- **Файл:** `connection.conf` (или зашифрованная секция в json).
- **Расположение:** Папка `/app_data/config/` на сервере.
- **Содержимое:**

```json
{
  "IsConfigured": true,
  "ConnectionString": "Host=192.168.1.10;Port=5432;Database=splitflow_prod;Username=postgres;Password=..."
}
```

- **Поведение:** При старте API проверяет наличие этого файла. Если файла нет или `IsConfigured: false` — все запросы перенаправляются на контроллер `SetupController`.

## 1.3 - Клиентская конфигурация (Frontend)

Параметры сборки Vite (`.env`).

| Параметр             | Значение                                      |
| :------------------- | :-------------------------------------------- |
| `VITE_API_BASE_URL`    | `/api` (через прокси) или полный URL        |
| `VITE_APP_NAME`        | "Splitflow"                                 |
| `VITE_TIMEOUT `        | `10000` (10 сек на запрос)                  |

# 2 - Хранение данных

## 2.1 - Серверное хранение

1. **Основная БД (PostgreSQL):**
    - Все бизнес-данные: Задачи, Проекты, Сотрудники, История изменений.
    - Пароли пользователей: Хранятся только в виде хешей (BCrypt/Argon2).

2. **Файловая система:**
    - Логи приложения (`/logs/log-20250130.txt`) — ротация ежедневно.
    - Аватарки сотрудников (если не используется внешний CDN): `/wwwroot/avatars/`.

## 2.2 - Клиентское хранение (Browser)

| Тип хранилища      | Ключ                  | Данные                                         | TTL (Срок жизни)                               |
| :----------------- | :-------------------- | :--------------------------------------------- | :--------------------------------------------- |
| localStorage       | `access_token`          | JWT Token для доступа к API.                   | До выхода (Logout) или истечения срока.        |
| localStorage       | `user_theme `           | Тема интерфейса (Light/Dark).                  | Бессрочно.                                     |
| sessionStorage     |`current_project_id`    | ID выбранного проекта в шапке (фильтр).        | До закрытия вкладки.                           |
| Cache (Browser)    | `*.js, *.css, *.png`    | Статика и ассеты.                              | Стандартный HTTP Cache-Control.                |

# 3 - Ограничения (Constraints)

## 3.1 - Инварианты данных (Validation Rules)

Эти правила проверяются на Бэкенде (FluentValidation) и дублируются на Фронтенде.

1. Сотрудники (Employees):
    - `ClearanceLevel`: Строго 1..5 (где 5 — высший).
    - `KPI`: Допустимые значения из списка: A+, A, A-, B+, B, C, D.
    - `Email`: Уникальный в рамках системы. Домен корпоративный (валидация regex).

2. Задачи (Tasks):
    - `Title`: Мин. 3 символа, макс. 150 символов.
    - `Description`: Макс. 2000 символов (HTML/Markdown не поддерживаем в MVP, только plain text).
    - `Deadline`: Дата не может быть меньше даты создания (только для новых задач).

3. Проекты:
    - Коды проектов (тэги) фиксированы форматом: 3 буквы + дефис + цифры (пример: `UK-EXT-9942`).

## 3.2 - Технические лимиты

- **Rate Limiting:** Ограничение 100 запросов в минуту с одного IP (защита от спама/DDoS).
- **Размер запроса:** Тело запроса (Body) не более 1 МБ (так как файлы не грузим).
- **Таймаут БД:** Операции с базой прерываются, если идут дольше 15 секунд.

# 4 - Политика обработки ошибок

Система придерживается принципа "Fail Safe" для UI и "Fail Fast" для API валидации.

## 4.1 - Ответы API (RFC 7807 Problem Details)

В случае ошибки сервер возвращает JSON с кодом ошибки и человекочитаемым сообщением.

```json
// Пример 400 Bad Request
{
  "type": "ValidationException",
  "title": "Ошибка валидации данных",
  "status": 400,
  "detail": "Поле 'Заголовок' обязательно для заполнения.",
  "instance": "/api/tasks/create"
}
```

## 4.2 - Отображение пользователю

| Тип ошибки               | HTTP Код | Сообщение в UI (Toast/Alert)                          | Действие UI                                   |
| :----------------------- | :------- | :---------------------------------------------------- | :-------------------------------------------- |
| Нет авторизации          | 401      | "Ваша сессия истекла. Пожалуйста, войдите снова."     | Редирект на /login.                           |
| Нет прав                 | 403      | "У вас недостаточно прав для выполнения этой операции."| Оставаться на странице, сбросить действие.    |
| Не найдено               | 404      | "Запрашиваемый ресурс (задача/сотрудник) не найден."  | Редирект на список или заглушка.              |
| Ошибка сервера           | 500      | "Внутренняя ошибка сервиса. Мы уже работаем над этим."| Показать Toast. Не блокировать интерфейс.     |
| Нет сети                 | -        | "Отсутствует подключение к серверу."                  | Блокировать кнопки сохранения, показать индикатор оффлайн. |
| БД не настроена          | 428 (Precondition Required) | -                                           | Автоматический редирект на /setup.            |

## 4.3 - Логирование

Чувствительные данные (пароли, токены) никогда не пишутся в логи.

- **Логируем:**
    - Старт/Стоп приложения.
    - Исключения (Stack Trace).
    - Факты изменения критических данных (Кто и когда удалил задачу — Audit Log).
    - Ошибки подключения к внешней БД.